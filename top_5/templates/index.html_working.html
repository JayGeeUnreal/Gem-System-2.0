<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stream Chat Manager</title>
    <style>
        :root { --col-platform: 60px; --col-source: 100px; --col-user: 220px; --col-time: 85px; --col-spacer: 0px; }
        body { font-family: 'Segoe UI', sans-serif; background-color: #1e1e1e; color: #f0f0f0; margin: 0; padding: 20px; }
        .container { max-width: 98%; margin: 0 auto; background: #252526; padding: 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        .top-section { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; align-items: flex-start; }
        .header-left { flex: 1; min-width: 300px; }
        h1 { margin: 0 0 15px 0; color: #61dafb; font-size: 24px; display: flex; align-items: center; gap: 15px; }
        .counter-badge { background: #204a87; color: #fff; font-size: 14px; padding: 4px 12px; border-radius: 20px; border: 1px solid #3465a4; display: inline-flex; align-items: center; gap: 8px; }
        .counter-number { font-weight: bold; font-size: 16px; color: #61dafb; }
        .header-btn { width: 28px; height: 28px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; border: none; border-radius: 4px; }
        .reset-btn { background: #a40000; color: white; border-radius: 50%; }
        .pause-btn { background: #eebb00; color: black; margin-left: 5px; }
        .pause-btn.is-paused { background: #204a87; color: white; }
        .settings-panel { background: #333; padding: 10px 15px; border-radius: 6px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .setting-item { display: flex; flex-direction: column; font-size: 11px; color: #bbb; }
        .setting-item input[type=range] { margin-top: 5px; cursor: pointer; width: 60px; }
        .leaderboard-panel { width: 250px; background: #1a1a1a; border: 1px solid #444; border-radius: 6px; padding: 10px; }
        .lb-title { font-size: 12px; font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 3px; margin-bottom: 3px; text-transform: uppercase; }
        .lb-entry { display: flex; justify-content: space-between; font-size: 11px; padding: 2px 0; border-bottom: 1px solid #252526; }
        .lb-user { color: #ccc; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 5px; }
        .lb-score { color: #61dafb; font-weight: bold; }
        .tabs { display: flex; border-bottom: 2px solid #333; margin-bottom: 10px; }
        .tab-btn { background: none; border: none; padding: 10px 20px; color: #888; cursor: pointer; font-size: 16px; font-weight: bold; }
        .tab-btn.active { color: #61dafb; border-bottom: 3px solid #61dafb; }
        .content-section { display: none; height: 600px; overflow-y: auto; background: #1e1e1e; border: 1px solid #333; border-radius: 4px; }
        .content-section.active { display: block; }
        .chat-entry { display: grid; grid-template-columns: var(--col-platform) var(--col-source) var(--col-user) 1fr var(--col-time) var(--col-spacer); gap: 10px; padding: 8px; border-bottom: 1px solid #333; align-items: center; }
        .platform-icon { font-size: 10px; padding: 3px 6px; border-radius: 3px; background: #444; color: #ccc; width: 100%; text-align: center; }
        .source-tag { display: block; font-size: 11px; color: #999; background: #2d2d30; border: 1px solid #444; padding: 2px 6px; border-radius: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-align: center; }
        .col-user { display: flex; align-items: center; gap: 6px; overflow: hidden; color: #eebb00; font-weight: bold; }
        .avatar-img { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; border: 1px solid #555; flex-shrink: 0; }
        .username-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .col-message { color: #ddd; word-break: break-word; font-size: 15px; line-height: 1.4; }
        .col-message img { max-height: 24px !important; max-width: auto !important; vertical-align: -5px; }
        .col-time { font-size: 0.8em; color: #666; text-align: right; white-space: nowrap; overflow: hidden; }
        .badge-icon { width: 16px; height: 16px; flex-shrink: 0; margin-left: 2px; }
        .mod-spanner { width: 14px; height: 14px; fill: #5e81ac; background: #252526; border-radius: 2px; padding: 1px; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e1e1e; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
        
        .yt-alert { display: none; background: #cc0000; color: white; padding: 10px; margin-bottom: 20px; border-radius: 6px; text-align: center; font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        .yt-alert a { color: #fff; text-decoration: underline; margin-left: 10px; }
        .transcribe-container { padding: 20px; display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .file-drop-area { border: 2px dashed #555; padding: 30px; text-align: center; background: #222; border-radius: 10px; width: 80%; cursor: pointer; }
        .file-drop-area:hover { border-color: #61dafb; background: #2a2a2a; }
        .transcribe-btn { background: #204a87; color: white; padding: 10px 30px; border: none; font-size: 18px; border-radius: 5px; cursor: pointer; opacity: 0.5; pointer-events: none; }
        .transcribe-btn.ready { opacity: 1; pointer-events: auto; }
        .transcribe-output { width: 90%; height: 300px; background: #111; color: #ddd; padding: 15px; border: 1px solid #444; border-radius: 5px; overflow-y: auto; white-space: pre-wrap; }
        .loading-spinner { display: none; color: #eebb00; font-weight: bold; margin-top: 10px; }
        .extract-container { padding: 20px; text-align:center; }
        .extract-input { width: 300px; padding: 10px; background: #333; color: #fff; border: 1px solid #555; border-radius: 4px; margin-right: 10px; }
        .extract-select { padding: 10px; background: #444; color: #fff; border: 1px solid #555; border-radius: 4px; min-width: 250px; }
        .extract-btn { padding: 10px 20px; background: #107516; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .extract-result { margin-top: 20px; font-size: 16px; color: #61dafb; }

        /* MODAL WIDER */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); }
        .modal-content { background-color: #252526; margin: 2% auto; padding: 20px; border: 1px solid #444; width: 95%; max-width: 1300px; border-radius: 10px; height: 90vh; display: flex; flex-direction: column; }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-modal:hover { color: #fff; }
        .manager-body { flex-grow: 1; overflow-y: auto; display: flex; gap: 20px; padding-top: 10px; }
        .manager-column { flex: 1; background: #1e1e1e; padding: 15px; border-radius: 8px; border: 1px solid #333; display: flex; flex-direction: column; }
        .manager-title { font-size: 18px; color: #eebb00; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; text-transform: uppercase; }
        .group-card { background: #2d2d30; border: 1px solid #444; border-radius: 6px; padding: 10px; margin-bottom: 10px; position: relative; }
        .group-header { font-weight: bold; color: #fff; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        .group-header-text { font-size: 14px; color: #61dafb; }
        .delete-group-btn { color: #ff5555; cursor: pointer; font-size: 12px; font-weight: bold; border: 1px solid #555; padding: 2px 6px; border-radius: 4px; }
        .delete-group-btn:hover { background: #ff5555; color: white; }
        .chip-container { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 8px; }
        .word-chip { background: #444; color: #ddd; padding: 3px 8px; border-radius: 12px; font-size: 12px; border: 1px solid #555; display: flex; align-items: center; gap: 5px; }
        .word-chip.is-title { background: #204a87; color: white; border-color: #61dafb; }
        .delete-chip { cursor: pointer; color: #ff9999; font-weight: bold; margin-left: 5px; }
        .promote-chip { cursor: pointer; color: #eebb00; font-size: 14px; line-height: 1; margin-right: 2px;}
        .add-word-row { display: flex; gap: 5px; }
        .add-word-input { background: #1a1a1a; border: 1px solid #555; color: #fff; padding: 4px; border-radius: 3px; flex-grow: 1; font-size: 12px; }
        .add-word-btn { background: #333; color: #fff; border: 1px solid #555; cursor: pointer; font-weight: bold; padding: 0 8px; border-radius: 3px; }
        .add-group-btn { width: 100%; padding: 10px; background: #333; color: #aaa; border: 1px dashed #555; cursor: pointer; margin-top: 10px; border-radius: 6px; }
        .save-btn { width: 100%; padding: 15px; background: #eebb00; color: #000; font-weight: bold; font-size: 18px; border: none; border-radius: 5px; cursor: pointer; margin-top: 20px; }
        .file-controls { background: #2d2d30; padding: 10px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #444; display: flex; gap: 10px; align-items: center; }
        .load-btn { background: #204a87; color: white; border: none; padding: 6px 15px; border-radius: 3px; cursor: pointer; }
        .simple-list-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .simple-chip { background: #444; color: #fff; padding: 5px 10px; border-radius: 4px; border: 1px solid #555; font-size: 13px; display: flex; align-items: center; gap: 8px;}
        .simple-chip-delete { color: #ff5555; cursor: pointer; font-weight: bold; }
        .yt-input { width: 100%; padding: 8px; background: #333; border: 1px solid #555; color: #fff; border-radius: 4px; margin-bottom: 10px; }
        .yt-label { color: #ccc; font-size: 12px; margin-bottom: 5px; display: block; }
        
        .footer-controls { display: flex; align-items: center; gap: 10px; margin-top: 10px; }
        .footer-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .footer-label { color: #ddd; font-size: 14px; cursor: pointer; }
        .sound-control { display: flex; align-items: center; gap: 5px; margin-right: 10px; font-size: 12px; color: #ccc; }
        .sound-checkbox { cursor: pointer; }
    </style>
</head>
<body>
<div class="container">
    <audio id="alert-sound" src="/static/ding.mp3"></audio>
    <div id="yt-alert" class="yt-alert"></div>
    <div class="top-section">
        <div class="header-left">
            <h1>
                Social Stream Ninja 
                <div class="counter-badge">Total: <span id="post-counter" class="counter-number">0</span></div> 
                <button id="pause-btn" class="header-btn pause-btn" onclick="togglePause()" title="Pause Monitor">II</button>
                <button class="header-btn reset-btn" onclick="resetSession()" title="Reset Session" style="margin-left: 5px;">‚ü≥</button>
            </h1>
            
            <div class="settings-panel">
                <div class="setting-item" style="justify-content: center;">
                    <div class="sound-control">
                        <input type="checkbox" id="sound-toggle" class="sound-checkbox">
                        <label for="sound-toggle">üîä Sound</label>
                    </div>
                </div>
                <div class="setting-item"><label>Plat</label><input type="range" min="30" max="150" value="60" oninput="updateWidth('--col-platform', this.value)"></div>
                <div class="setting-item"><label>Source</label><input type="range" min="0" max="250" value="100" oninput="updateWidth('--col-source', this.value)"></div>
                <div class="setting-item"><label>User</label><input type="range" min="100" max="400" value="220" oninput="updateWidth('--col-user', this.value)"></div>
                <div class="setting-item"><label>Time</label><input type="range" min="40" max="200" value="85" oninput="updateWidth('--col-time', this.value)"></div>
                <div class="setting-item"><label style="color:#61dafb">Margin</label><input type="range" min="0" max="800" value="0" oninput="updateWidth('--col-spacer', this.value)"></div>
                <div class="setting-item" style="border-left:1px solid #444; padding-left:10px; flex-grow: 1; align-items: flex-end;">
                     <button onclick="openManager()" style="padding: 10px 20px; background:#444; border:1px solid #666; color:#fff; cursor:pointer; border-radius:4px; font-weight:bold;">üìã Manage Keywords</button>
                </div>
            </div>
        </div>
        <div class="leaderboard-panel">
            <div class="lb-title" style="color:#eebb00">üèÜ Mentions</div>
            <div id="lb-content-mentions"><div style="text-align:center;color:#555;font-size:11px;">...</div></div>
            <div class="lb-title" style="color:#ff5555; margin-top:10px;">ü§¨ Shit Talkers</div>
            <div id="lb-content-talkers"><div style="text-align:center;color:#555;font-size:11px;">...</div></div>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('live', this)">Live Monitor</button>
        <button class="tab-btn" onclick="switchTab('logs', this)">History</button>
        <button class="tab-btn" onclick="switchTab('transcribe', this)">Transcribe Video</button>
        <button class="tab-btn" onclick="switchTab('extract', this)">Filter & Extract</button>
    </div>

    <!-- TABS CONTENT -->
    <div id="live" class="content-section active"><div style="text-align:center; padding: 20px; color:#555;">Waiting...</div></div>
    
    <div id="logs" class="content-section"><div class="file-controls"><select id="file-dropdown" style="background:#444;color:#fff;padding:5px; min-width:200px;"></select> <button onclick="loadSelectedFile(true)" class="load-btn">Load</button></div><div id="logs-content"><div style="text-align:center; padding: 20px; color:#555;">Loading...</div></div></div>
    
    <div id="transcribe" class="content-section">
        <div class="transcribe-container">
            <div class="file-drop-area">
                <p style="color:#aaa; margin-bottom:10px;">Select Video/Audio File (MP4, MP3, WAV)</p>
                <input type="file" id="videoFile" accept="video/*,audio/*" onchange="fileSelected()">
            </div>
            <button id="btn-transcribe" class="transcribe-btn" onclick="uploadAndTranscribe()">Start Transcription</button>
            <div id="loading-txt" class="loading-spinner">‚è≥ Processing... Please wait...</div>
            <textarea id="transcribe-output" class="transcribe-output" placeholder="Transcript will appear here..."></textarea>
        </div>
    </div>

    <div id="extract" class="content-section">
        <div class="extract-container">
            <h2 style="color:#eebb00">Search & Extract Logs</h2>
            <p style="color:#aaa; font-size:14px; margin-bottom:20px;">
                Select a log file (Text or JSONL), enter a keyword, and I will create a new text file containing only the matching lines.
            </p>
            
            <div style="margin-bottom:15px;">
                <label style="display:block; color:#ccc; margin-bottom:5px;">1. Select Source Log:</label>
                <select id="extract-file-dropdown" class="extract-select"></select>
            </div>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; color:#ccc; margin-bottom:5px;">2. Enter Keyword (Case-Insensitive):</label>
                <input type="text" id="extract-keyword" class="extract-input" placeholder="e.g. Jaygee">
                <button onclick="runExtraction()" class="extract-btn">Run Extraction</button>
            </div>

            <div id="extract-result" class="extract-result"></div>
        </div>
    </div>
</div>

<!-- MANAGER MODAL -->
<div id="wordManager" class="modal">
    <div class="modal-content">
        <span class="close-modal" onclick="closeManager()">&times;</span>
        <h2 style="color:#fff; margin-top:0; border-bottom:1px solid #444; padding-bottom:10px;">Manage Keywords & Settings</h2>
        
        <div style="background:#202020; padding:15px; border-radius:5px; margin-bottom:20px; border:1px solid #444;">
            <div class="manager-title" style="color:#ff5555; font-size:14px;">YouTube Monitor (Requires Restart)</div>
            <label class="yt-label">API Key</label>
            <input type="password" id="yt-api-key" class="yt-input" placeholder="Google API Key">
            <label class="yt-label">Channel IDs to Monitor</label>
            <div style="display:flex; gap:10px; margin-bottom:5px;">
                <input type="text" id="yt-channel-input" class="yt-input" style="margin-bottom:0;" placeholder="UCxxxx..." onkeypress="handleYTEnter(event)">
                <button onclick="addYTChannel()" style="background:#444; color:#fff; border:1px solid #555; cursor:pointer; padding:0 15px;">Add</button>
            </div>
            <div id="container-yt-channels" class="simple-list-container"></div>
        </div>

        <div class="manager-body">
            <div class="manager-column">
                <div class="manager-title">üèÜ Mentions</div>
                <div id="container-mentions" style="flex-grow:1; overflow-y:auto;"></div>
                <button class="add-group-btn" onclick="createNewGroup('mentions')">+ Add New Group</button>
            </div>
            <div class="manager-column">
                <div class="manager-title" style="color:#ff5555">ü§¨ Shit Talkers</div>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="simple-talker-input" placeholder="Type bad word & hit Enter" style="flex-grow:1; padding:8px; background:#333; border:1px solid #555; color:#fff;" onkeypress="handleSimpleEnter(event)">
                    <button onclick="addSimpleTalker()" style="background:#ff5555; color:#fff; border:none; padding:8px 15px; cursor:pointer;">Add</button>
                </div>
                <div id="container-talkers" class="simple-list-container"></div>
            </div>
            
            <!-- NEW COLUMN 3: IGNORED PHRASES -->
            <div class="manager-column">
                <div class="manager-title" style="color:#888">‚õî Ignored Phrases</div>
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="ignore-input" placeholder="e.g. Jay Smith" style="flex-grow:1; padding:8px; background:#333; border:1px solid #555; color:#fff;" onkeypress="handleIgnoreEnter(event)">
                    <button onclick="addIgnore()" style="background:#888; color:#fff; border:none; padding:8px 15px; cursor:pointer;">Add</button>
                </div>
                <div id="container-ignored" class="simple-list-container"></div>
            </div>
        </div>
        
        <div class="footer-controls">
            <input type="checkbox" id="reset-toggle" class="footer-checkbox">
            <label for="reset-toggle" class="footer-label">Reset counters to 0 when saving?</label>
        </div>
        <button class="save-btn" onclick="saveAllWords()">SAVE SETTINGS</button>
    </div>
</div>

<div style="display:none;"><svg id="icon-spanner" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M501.1 395.7L384 278.6c-1.6-1.6-3.8-2.5-6.1-2.5h-5.8c12.2-31.9 12.5-67.4-2.1-100.8-21.7-49.8-71.1-81.8-125.6-81.8-12.8 0-25.5 1.8-37.8 5.4l59.6 59.6c6.2 6.2 6.2 16.4 0 22.6l-22.6 22.6c-6.2 6.2-16.4 6.2-22.6 0l-59.6-59.6C125.3 162 122 181.7 132.8 206.3c15 34.1 46.4 61.2 82.5 73.1v5.8c0 2.3.9 4.5 2.5 6.1l117.1 117.1c9.4 9.4 24.6 9.4 33.9 0l132.3-132.3c9.4-9.4 9.4-24.6 0-33.9zm-460.6-21.3l127.6-39.7c5.8-1.8 9.1-8.1 7.2-13.9L135.6 205c-1.8-5.8-8.1-9.1-13.9-7.2L34.1 237.5c-20 6.2-28.5 28.7-16.5 45.2l37.2 51.3-51.3 37.2C-8.5 383.2 0 405.7 20 411.9l115.8 36c5.8 1.8 12.1-1.5 13.9-7.2l30.3-115.8c1.8-5.8-1.5-12.1-7.2-13.9l-115.8-30.3c-5.8-1.8-9.1-8.1-7.2-13.9l39.7-127.6z"/></svg></div>

<script>
    let liveInterval=null; let logsInterval=null;
    let localMentions=[]; let localTalkers=[]; let localYTChannels=[]; let localIgnored=[];
    let isUserPaused = false; 
    let lastKnownScoreTime = 0; 

    function updateWidth(v, val) { document.documentElement.style.setProperty(v, val+'px'); }
    
    function togglePause() {
        const btn = document.getElementById('pause-btn');
        if(!isUserPaused) { isUserPaused=true; stopLive(); btn.innerText="‚ñ∂"; btn.classList.add('is-paused'); }
        else { isUserPaused=false; startLive(); btn.innerText="II"; btn.classList.remove('is-paused'); }
    }

    function switchTab(t, btn) { 
        document.querySelectorAll('.content-section').forEach(e=>e.classList.remove('active'));
        document.getElementById(t).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(e=>e.classList.remove('active'));
        if(btn) btn.classList.add('active');
        
        if(t==='live') { stopLogs(); if(!isUserPaused) startLive(); } 
        else { stopLive(); if(t==='logs') loadFiles(); else if(t==='extract') loadExtractFiles(); }
    }
    
    function fileSelected() {
        const input = document.getElementById('videoFile');
        const btn = document.getElementById('btn-transcribe');
        if(input.files.length > 0) btn.classList.add('ready');
    }

    async function uploadAndTranscribe() {
        const input = document.getElementById('videoFile');
        const file = input.files[0];
        if(!file) return;
        const formData = new FormData();
        formData.append('file', file);
        document.getElementById('loading-txt').style.display = 'block';
        document.getElementById('transcribe-output').value = "Processing...";
        try {
            const res = await fetch('/api/transcribe', { method: 'POST', body: formData });
            const data = await res.json();
            document.getElementById('loading-txt').style.display = 'none';
            document.getElementById('transcribe-output').value = data.status === 'success' ? data.text : "Error: " + data.message;
        } catch(err) {
            document.getElementById('loading-txt').style.display = 'none';
            document.getElementById('transcribe-output').value = "Network Error.";
        }
    }

    async function loadExtractFiles() {
        const r=await fetch('/api/files'); const f=await r.json();
        const s=document.getElementById('extract-file-dropdown'); s.innerHTML='';
        f.forEach(n=>{ 
            let o=document.createElement('option'); o.value=n; 
            o.text=n;
            if(n.includes('.txt')) o.selected = true; 
            s.appendChild(o); 
        });
    }

    async function runExtraction() {
        const filename = document.getElementById('extract-file-dropdown').value;
        const keyword = document.getElementById('extract-keyword').value;
        const resultDiv = document.getElementById('extract-result');
        if(!filename || !keyword) { resultDiv.innerText = "Please select a file and enter a keyword."; return; }
        resultDiv.innerHTML = '<span style="color:#eebb00">Extracting...</span>';
        try {
            const res = await fetch('/api/extract', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({filename: filename, keyword: keyword})
            });
            const data = await res.json();
            if(data.status === 'success') {
                resultDiv.innerHTML = `Success! Found <b>${data.count}</b> matches.<br>Saved to: <code style="color:#fff">${data.file}</code>`;
            } else {
                resultDiv.innerHTML = `<span style="color:red">Error: ${data.message}</span>`;
            }
        } catch(err) { resultDiv.innerHTML = '<span style="color:red">Network Error</span>'; }
    }

    function openManager() {
        document.getElementById('wordManager').style.display='block';
        fetch('/api/live').then(r=>r.json()).then(d => {
            localMentions = d.groups_mentions || [];
            localTalkers = d.groups_talkers || [];
            localYTChannels = d.yt_channels || [];
            localIgnored = d.groups_ignored || [];
            document.getElementById('yt-api-key').value = d.yt_key || "";
            renderManager('mentions');
            renderManager('talkers');
            renderYTChannels();
            renderIgnored();
        });
    }
    function closeManager() { document.getElementById('wordManager').style.display='none'; }

    function renderManager(type) {
        if(type==='talkers') return renderTalkers();
        const container = document.getElementById('container-mentions');
        container.innerHTML = '';
        localMentions.forEach((group, groupIdx) => {
            const title = group.length > 0 ? group[0] : "Empty Group";
            let chipsHtml = '';
            group.forEach((word, wordIdx) => {
                const isTitle = wordIdx === 0;
                const starHtml = isTitle ? '' : `<span class="promote-chip" onclick="promoteWord(${groupIdx}, ${wordIdx})" title="Make Title">‚òÖ</span>`;
                const titleClass = isTitle ? 'is-title' : '';
                chipsHtml += `<div class="word-chip ${titleClass}">${starHtml}${word}<span class="delete-chip" onclick="removeMentionWord(${groupIdx}, ${wordIdx})">&times;</span></div>`;
            });
            container.innerHTML += `
                <div class="group-card">
                    <div class="group-header">
                        <span class="group-header-text">${title}</span>
                        <span class="delete-group-btn" onclick="deleteMentionGroup(${groupIdx})">DELETE GROUP</span>
                    </div>
                    <div class="chip-container">${chipsHtml}</div>
                    <div class="add-word-row">
                        <input type="text" class="add-word-input" id="input-mentions-${groupIdx}" placeholder="Add..." onkeypress="handleMentionEnter(event, ${groupIdx})">
                        <button class="add-word-btn" onclick="addWordToMention(${groupIdx})">+</button>
                    </div>
                </div>
            `;
        });
    }

    function renderTalkers() {
        const container = document.getElementById('container-talkers');
        container.innerHTML = '';
        localTalkers.forEach((group, groupIdx) => {
            if(group.length > 0) {
                const word = group[0]; 
                container.innerHTML += `<div class="simple-chip">${word}<span class="simple-chip-delete" onclick="removeTalker(${groupIdx})">&times;</span></div>`;
            }
        });
    }

    function renderIgnored() {
        const container = document.getElementById('container-ignored');
        container.innerHTML = '';
        localIgnored.forEach((word, idx) => {
            container.innerHTML += `<div class="simple-chip">${word}<span class="simple-chip-delete" onclick="removeIgnored(${idx})">&times;</span></div>`;
        });
    }

    function renderYTChannels() {
        const container = document.getElementById('container-yt-channels');
        container.innerHTML = '';
        localYTChannels.forEach((chan, idx) => {
            container.innerHTML += `<div class="simple-chip">${chan}<span class="simple-chip-delete" onclick="removeYTChannel(${idx})">&times;</span></div>`;
        });
    }
    
    function addYTChannel() {
        const input = document.getElementById('yt-channel-input');
        const val = input.value.trim();
        if(val) { if(!localYTChannels.includes(val)) { localYTChannels.push(val); renderYTChannels(); } input.value = ''; }
    }
    function handleYTEnter(e) { if(e.key==='Enter') addYTChannel(); }
    function removeYTChannel(idx) { localYTChannels.splice(idx, 1); renderYTChannels(); }

    function addIgnore() {
        const input = document.getElementById('ignore-input');
        const val = input.value.trim();
        if(val) {
            // Case-Insensitive check
            const exists = localIgnored.some(w => w.toLowerCase() === val.toLowerCase());
            if(exists) { alert("Already in list"); return; }
            localIgnored.push(val);
            input.value = '';
            renderIgnored();
        }
    }
    function handleIgnoreEnter(e) { if(e.key==='Enter') addIgnore(); }
    function removeIgnored(idx) { localIgnored.splice(idx, 1); renderIgnored(); }

    function addWordToMention(groupIdx) {
        const input = document.getElementById(`input-mentions-${groupIdx}`);
        const val = input.value.trim();
        if(val) {
            const exists = localMentions[groupIdx].some(w => w.toLowerCase() === val.toLowerCase());
            if(exists) { alert("Word exists!"); return; }
            localMentions[groupIdx].push(val);
            input.value = '';
            renderManager('mentions');
        }
    }
    
    function addSimpleTalker() {
        const input = document.getElementById('simple-talker-input');
        const val = input.value.trim();
        if(val) {
            const exists = localTalkers.some(g => g[0].toLowerCase() === val.toLowerCase());
            if(exists) { alert("Word exists!"); return; }
            localTalkers.push([val]);
            input.value='';
            renderTalkers();
        }
    }

    function handleMentionEnter(e, idx) { if(e.key==='Enter') addWordToMention(idx); }
    function handleSimpleEnter(e) { if(e.key==='Enter') addSimpleTalker(); }
    function removeMentionWord(groupIdx, wordIdx) { localMentions[groupIdx].splice(wordIdx, 1); renderManager('mentions'); }
    function deleteMentionGroup(groupIdx) { if(confirm("Delete group?")) { localMentions.splice(groupIdx, 1); renderManager('mentions'); } }
    function removeTalker(idx) { localTalkers.splice(idx, 1); renderTalkers(); }
    function createNewGroup(type) { if(type==='mentions') localMentions.push([]); renderManager('mentions'); }
    function promoteWord(groupIdx, wordIdx) {
        const word = localMentions[groupIdx].splice(wordIdx, 1)[0];
        localMentions[groupIdx].unshift(word);
        renderManager('mentions');
    }

    async function saveAllWords() {
        localMentions = localMentions.filter(g => g.length > 0);
        localTalkers = localTalkers.filter(g => g.length > 0);
        const ytKey = document.getElementById('yt-api-key').value;
        const doReset = document.getElementById('reset-toggle').checked;

        try {
            await fetch('/api/set_words', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                    mentions: localMentions, 
                    talkers: localTalkers,
                    ignored: localIgnored,
                    yt_key: ytKey,
                    yt_channels: localYTChannels,
                    reset: doReset
                })
            });
            alert("Settings Saved!");
            closeManager();
            fetchLive();
        } catch(e) { alert("Error saving"); console.error(e); }
    }

    function renderBadges(msg) {
        let h=''; const b=msg.chatbadges||[]; let isMod=msg.mod||msg.moderator||msg.isMod||(msg.tags&&(msg.tags.mod==='1'||msg.tags.moderator==='1'))||(b.some(x=>x.type==='moderator'||(x.src&&x.src.includes('moderator'))));
        if(isMod) h+=`<svg class="badge-icon mod-spanner" viewBox="0 0 512 512">${document.getElementById('icon-spanner').innerHTML}</svg>`;
        if(b.length>0) h+=b.map(x=>x.src?`<img src="${x.src}" class="badge-icon">`: '').join('');
        return h;
    }
    function renderMessages(id, d) {
        const c=document.getElementById(id); if(!d||d.length===0){c.innerHTML='<div style="padding:20px;text-align:center;color:#555">None</div>';return;}
        let h=''; d.forEach(m=>{
            const t=m.timestamp?new Date(parseInt(m.timestamp)).toLocaleTimeString():'';
            const src=m.sourceName?`<span class="source-tag" title="${m.sourceName}">${m.sourceName}</span>`:'';
            const av=m.chatimg?`<img src="${m.chatimg}" class="avatar-img">`:`<div class="avatar-img" style="background:#555"></div>`;
            const user = m.chatname || m.user || m.username || m.nickname || 'Anon';
            const msgText = m.message || m.chatmessage || '';
            h+=`<div class="chat-entry"><div class="col-platform"><span class="platform-icon">${m.type||'UNK'}</span></div><div class="col-source">${src}</div><div class="col-user">${av}<span class="username-text" title="${user}">${user}</span>${renderBadges(m)}</div><div class="col-message">${msgText}</div><div class="col-time">${t}</div><div class="col-spacer"></div></div>`;
        });
        c.innerHTML=h;
    }
    function renderLB(id, data) {
        const c=document.getElementById(id);
        if(!data||data.length===0){c.innerHTML='<div style="text-align:center;color:#555;font-size:10px;">-</div>';return;}
        let h=''; data.forEach((e,i)=>{ h+=`<div class="lb-entry"><div class="lb-user">${e[0]}</div><div class="lb-score">${e[1]}</div></div>`; });
        c.innerHTML=h;
    }
    async function fetchLive() {
        try {
            const res=await fetch('/api/live'); const d=await res.json();
            renderMessages('live', d.messages);
            document.getElementById('post-counter').innerText=d.post_count;
            renderLB('lb-content-mentions', d.leaderboard_mentions);
            renderLB('lb-content-talkers', d.leaderboard_talkers);
            
            if (d.last_score_time > lastKnownScoreTime) {
                if (lastKnownScoreTime !== 0 && document.getElementById('sound-toggle').checked) {
                    const audio = document.getElementById('alert-sound');
                    audio.currentTime = 0; 
                    audio.play().catch(e => console.log("Audio Blocked:", e));
                }
                lastKnownScoreTime = d.last_score_time;
            }
            if (lastKnownScoreTime === 0) lastKnownScoreTime = d.last_score_time;

            const alertBox = document.getElementById('yt-alert');
            if(d.upcoming_streams && d.upcoming_streams.length > 0) {
                alertBox.style.display = 'block';
                let html = 'üî¥ UPCOMING STREAMS DETECTED:<br>';
                d.upcoming_streams.forEach(s => {
                    html += `<a href="${s.url}" target="_blank">${s.title}</a><br>`;
                });
                alertBox.innerHTML = html;
            } else {
                alertBox.style.display = 'none';
            }
        } catch(e){}
    }
    async function resetSession() {
        if(!confirm("Reset Counters?")) return;
        await fetch('/api/reset_session', {method:'POST'}); fetchLive();
    }
    async function loadFiles() {
        const r=await fetch('/api/files'); const f=await r.json();
        const s=document.getElementById('file-dropdown'); s.innerHTML='';
        f.forEach(n=>{ let o=document.createElement('option'); o.value=n; o.text=n==='chat_log.jsonl'?n+" (CURRENT)":n; if(n==='chat_log.jsonl')o.selected=true; s.appendChild(o); });
        loadSelectedFile();
    }
    async function loadSelectedFile() {
        const n=document.getElementById('file-dropdown').value;
        const res=await fetch(`/api/logs?filename=${encodeURIComponent(n)}`);
        const d=await res.json(); renderMessages('logs-content', d);
        stopLogs();
        if(n==='chat_log.jsonl') logsInterval=setInterval(()=>loadSelectedFile(),3000);
    }
    function startLive(){ fetchLive(); if(!liveInterval) liveInterval=setInterval(fetchLive, 2000); }
    function stopLive(){ clearInterval(liveInterval); liveInterval=null; }
    function stopLogs(){ clearInterval(logsInterval); logsInterval=null; }
    startLive();
</script>
</body>
</html>